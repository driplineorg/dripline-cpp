language: cpp

stages:
  - build-test
    if: branch = master OR branch = develop OR branch =~ /.*\\/(?i:build)$/
  - name: deploy
    if: branch = master OR branch =~ /^v\d+\.\d+\.\d+(-S*)?$/ OR branch = develop

jobs:
  include:
    - stage: build-test
      os: osx
      compiler: clang
      osx_image: xcode9.4
      script:
        - brew update
        - brew install rabbitmq-c
        - mkdir build
        - cd build
        - cmake ..
        - make
    - stage: build-test
      os: linux
      dist: bionic
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-5
            - libboost-all-dev
            - librabbitmq-dev
      script:
        - export CC=gcc-5 && export CXX=g++-5
        - mkdir build
        - cd build
        - cmake .. -DScarab_BUILD_PYTHON=FALSE
        - make
    - stage: build-test
      os: linux
      dist: bionic
      compiler: clang
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - clang
            - libboost-all-dev
            - librabbitmq-dev
      script:
        - export CC=clang && export CXX=clang++
        - mkdir build               
        - cd build
        - cmake .. -DScarab_BUILD_PYTHON=FALSE
        - make
    - stage: deploy
      os: linux
      dist: bionic
      services:
        - docker
      addons:
        apt:
          packages:
            - docker-ce
      script:
        - export DOCKER_TAG=`echo $TRAVIS_BRANCH | sed "s/\//-/"`
        - docker build -t driplineorg/dripline-cpp:$DOCKER_TAG .
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push driplineorg/dripline-cpp:$DOCKER_TAG
   
